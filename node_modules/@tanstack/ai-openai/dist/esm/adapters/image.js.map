{"version":3,"file":"image.js","sources":["../../../src/adapters/image.ts"],"sourcesContent":["import { BaseImageAdapter } from '@tanstack/ai/adapters'\nimport {\n  createOpenAIClient,\n  generateId,\n  getOpenAIApiKeyFromEnv,\n} from '../utils/client'\nimport {\n  validateImageSize,\n  validateNumberOfImages,\n  validatePrompt,\n} from '../image/image-provider-options'\nimport type { OpenAIImageModel } from '../model-meta'\nimport type {\n  OpenAIImageModelProviderOptionsByName,\n  OpenAIImageModelSizeByName,\n  OpenAIImageProviderOptions,\n} from '../image/image-provider-options'\nimport type {\n  GeneratedImage,\n  ImageGenerationOptions,\n  ImageGenerationResult,\n} from '@tanstack/ai'\nimport type OpenAI_SDK from 'openai'\nimport type { OpenAIClientConfig } from '../utils/client'\n\n/**\n * Configuration for OpenAI image adapter\n */\nexport interface OpenAIImageConfig extends OpenAIClientConfig {}\n\n/**\n * OpenAI Image Generation Adapter\n *\n * Tree-shakeable adapter for OpenAI image generation functionality.\n * Supports gpt-image-1, gpt-image-1-mini, dall-e-3, and dall-e-2 models.\n *\n * Features:\n * - Model-specific type-safe provider options\n * - Size validation per model\n * - Number of images validation\n */\nexport class OpenAIImageAdapter<\n  TModel extends OpenAIImageModel,\n> extends BaseImageAdapter<\n  TModel,\n  OpenAIImageProviderOptions,\n  OpenAIImageModelProviderOptionsByName,\n  OpenAIImageModelSizeByName\n> {\n  readonly kind = 'image' as const\n  readonly name = 'openai' as const\n\n  private client: OpenAI_SDK\n\n  constructor(config: OpenAIImageConfig, model: TModel) {\n    super({}, model)\n    this.client = createOpenAIClient(config)\n  }\n\n  async generateImages(\n    options: ImageGenerationOptions<OpenAIImageProviderOptions>,\n  ): Promise<ImageGenerationResult> {\n    const { model, prompt, numberOfImages, size } = options\n\n    // Validate inputs\n    validatePrompt({ prompt, model })\n    validateImageSize(model, size)\n    validateNumberOfImages(model, numberOfImages)\n\n    // Build request based on model type\n    const request = this.buildRequest(options)\n\n    const response = await this.client.images.generate({\n      ...request,\n      stream: false,\n    })\n\n    return this.transformResponse(model, response)\n  }\n\n  private buildRequest(\n    options: ImageGenerationOptions<OpenAIImageProviderOptions>,\n  ): OpenAI_SDK.Images.ImageGenerateParams {\n    const { model, prompt, numberOfImages, size, modelOptions } = options\n\n    return {\n      model,\n      prompt,\n      n: numberOfImages ?? 1,\n      size: size as OpenAI_SDK.Images.ImageGenerateParams['size'],\n      ...modelOptions,\n    }\n  }\n\n  private transformResponse(\n    model: string,\n    response: OpenAI_SDK.Images.ImagesResponse,\n  ): ImageGenerationResult {\n    const images: Array<GeneratedImage> = (response.data ?? []).map((item) => ({\n      b64Json: item.b64_json,\n      url: item.url,\n      revisedPrompt: item.revised_prompt,\n    }))\n\n    return {\n      id: generateId(this.name),\n      model,\n      images,\n      usage: response.usage\n        ? {\n            inputTokens: response.usage.input_tokens,\n            outputTokens: response.usage.output_tokens,\n            totalTokens: response.usage.total_tokens,\n          }\n        : undefined,\n    }\n  }\n}\n\n/**\n * Creates an OpenAI image adapter with explicit API key.\n * Type resolution happens here at the call site.\n *\n * @param model - The model name (e.g., 'dall-e-3', 'gpt-image-1')\n * @param apiKey - Your OpenAI API key\n * @param config - Optional additional configuration\n * @returns Configured OpenAI image adapter instance with resolved types\n *\n * @example\n * ```typescript\n * const adapter = createOpenaiImage('dall-e-3', \"sk-...\");\n *\n * const result = await generateImage({\n *   adapter,\n *   prompt: 'A cute baby sea otter'\n * });\n * ```\n */\nexport function createOpenaiImage<TModel extends OpenAIImageModel>(\n  model: TModel,\n  apiKey: string,\n  config?: Omit<OpenAIImageConfig, 'apiKey'>,\n): OpenAIImageAdapter<TModel> {\n  return new OpenAIImageAdapter({ apiKey, ...config }, model)\n}\n\n/**\n * Creates an OpenAI image adapter with automatic API key detection from environment variables.\n * Type resolution happens here at the call site.\n *\n * Looks for `OPENAI_API_KEY` in:\n * - `process.env` (Node.js)\n * - `window.env` (Browser with injected env)\n *\n * @param model - The model name (e.g., 'dall-e-3', 'gpt-image-1')\n * @param config - Optional configuration (excluding apiKey which is auto-detected)\n * @returns Configured OpenAI image adapter instance with resolved types\n * @throws Error if OPENAI_API_KEY is not found in environment\n *\n * @example\n * ```typescript\n * // Automatically uses OPENAI_API_KEY from environment\n * const adapter = openaiImage('dall-e-3');\n *\n * const result = await generateImage({\n *   adapter,\n *   prompt: 'A beautiful sunset over mountains'\n * });\n * ```\n */\nexport function openaiImage<TModel extends OpenAIImageModel>(\n  model: TModel,\n  config?: Omit<OpenAIImageConfig, 'apiKey'>,\n): OpenAIImageAdapter<TModel> {\n  const apiKey = getOpenAIApiKeyFromEnv()\n  return createOpenaiImage(model, apiKey, config)\n}\n"],"names":[],"mappings":";;;AAyCO,MAAM,2BAEH,iBAKR;AAAA,EAMA,YAAY,QAA2B,OAAe;AACpD,UAAM,CAAA,GAAI,KAAK;AANjB,SAAS,OAAO;AAChB,SAAS,OAAO;AAMd,SAAK,SAAS,mBAAmB,MAAM;AAAA,EACzC;AAAA,EAEA,MAAM,eACJ,SACgC;AAChC,UAAM,EAAE,OAAO,QAAQ,gBAAgB,SAAS;AAGhD,mBAAe,EAAE,QAAQ,OAAO;AAChC,sBAAkB,OAAO,IAAI;AAC7B,2BAAuB,OAAO,cAAc;AAG5C,UAAM,UAAU,KAAK,aAAa,OAAO;AAEzC,UAAM,WAAW,MAAM,KAAK,OAAO,OAAO,SAAS;AAAA,MACjD,GAAG;AAAA,MACH,QAAQ;AAAA,IAAA,CACT;AAED,WAAO,KAAK,kBAAkB,OAAO,QAAQ;AAAA,EAC/C;AAAA,EAEQ,aACN,SACuC;AACvC,UAAM,EAAE,OAAO,QAAQ,gBAAgB,MAAM,iBAAiB;AAE9D,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA,GAAG,kBAAkB;AAAA,MACrB;AAAA,MACA,GAAG;AAAA,IAAA;AAAA,EAEP;AAAA,EAEQ,kBACN,OACA,UACuB;AACvB,UAAM,UAAiC,SAAS,QAAQ,CAAA,GAAI,IAAI,CAAC,UAAU;AAAA,MACzE,SAAS,KAAK;AAAA,MACd,KAAK,KAAK;AAAA,MACV,eAAe,KAAK;AAAA,IAAA,EACpB;AAEF,WAAO;AAAA,MACL,IAAI,WAAW,KAAK,IAAI;AAAA,MACxB;AAAA,MACA;AAAA,MACA,OAAO,SAAS,QACZ;AAAA,QACE,aAAa,SAAS,MAAM;AAAA,QAC5B,cAAc,SAAS,MAAM;AAAA,QAC7B,aAAa,SAAS,MAAM;AAAA,MAAA,IAE9B;AAAA,IAAA;AAAA,EAER;AACF;AAqBO,SAAS,kBACd,OACA,QACA,QAC4B;AAC5B,SAAO,IAAI,mBAAmB,EAAE,QAAQ,GAAG,OAAA,GAAU,KAAK;AAC5D;AA0BO,SAAS,YACd,OACA,QAC4B;AAC5B,QAAM,SAAS,uBAAA;AACf,SAAO,kBAAkB,OAAO,QAAQ,MAAM;AAChD;"}