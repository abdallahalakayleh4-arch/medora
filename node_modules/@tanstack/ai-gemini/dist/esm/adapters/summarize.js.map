{"version":3,"file":"summarize.js","sources":["../../../src/adapters/summarize.ts"],"sourcesContent":["import { FinishReason } from '@google/genai'\nimport {\n  createGeminiClient,\n  generateId,\n  getGeminiApiKeyFromEnv,\n} from '../utils'\nimport type { GoogleGenAI } from '@google/genai'\nimport type { GeminiClientConfig } from '../utils'\nimport type { SummarizeAdapter } from '@tanstack/ai/adapters'\nimport type {\n  StreamChunk,\n  SummarizationOptions,\n  SummarizationResult,\n} from '@tanstack/ai'\n\n/**\n * Configuration for Gemini summarize adapter\n */\nexport interface GeminiSummarizeConfig extends GeminiClientConfig {}\n/**\n * Available Gemini models for summarization\n */\nexport const GeminiSummarizeModels = [\n  'gemini-2.0-flash',\n  'gemini-1.5-flash',\n  'gemini-1.5-pro',\n  'gemini-2.0-flash-lite',\n] as const\n\nexport type GeminiSummarizeModel = (typeof GeminiSummarizeModels)[number]\n\n/**\n * Provider-specific options for Gemini summarization\n */\nexport interface GeminiSummarizeProviderOptions {\n  /** Generation configuration */\n  generationConfig?: {\n    temperature?: number\n    topP?: number\n    topK?: number\n    maxOutputTokens?: number\n    stopSequences?: Array<string>\n  }\n  /** Safety settings */\n  safetySettings?: Array<{\n    category: string\n    threshold: string\n  }>\n}\n\nexport interface GeminiSummarizeAdapterOptions {\n  // Additional adapter options can be added here\n}\n\n/**\n * Gemini Summarize Adapter\n * A tree-shakeable summarization adapter for Google Gemini\n */\nexport class GeminiSummarizeAdapter<\n  TModel extends GeminiSummarizeModel,\n> implements SummarizeAdapter<TModel, GeminiSummarizeProviderOptions> {\n  readonly kind = 'summarize' as const\n  readonly name = 'gemini' as const\n  readonly model: TModel\n\n  // Type-only property - never assigned at runtime\n  declare '~types': {\n    providerOptions: GeminiSummarizeProviderOptions\n  }\n\n  private client: GoogleGenAI\n\n  constructor(config: GeminiSummarizeConfig, model: TModel) {\n    this.client = createGeminiClient(config)\n    this.model = model\n  }\n\n  async summarize(options: SummarizationOptions): Promise<SummarizationResult> {\n    const model = options.model\n\n    // Build the system prompt based on format\n    const formatInstructions = this.getFormatInstructions(options.style)\n    const lengthInstructions = options.maxLength\n      ? ` Keep the summary under ${options.maxLength} tokens.`\n      : ''\n\n    const systemPrompt = `You are a helpful assistant that summarizes text. ${formatInstructions}${lengthInstructions}`\n\n    const response = await this.client.models.generateContent({\n      model,\n      contents: [\n        {\n          role: 'user',\n          parts: [\n            { text: `Please summarize the following:\\n\\n${options.text}` },\n          ],\n        },\n      ],\n      config: {\n        systemInstruction: systemPrompt,\n      },\n    })\n\n    const summary = response.text ?? ''\n    const inputTokens = response.usageMetadata?.promptTokenCount ?? 0\n    const outputTokens = response.usageMetadata?.candidatesTokenCount ?? 0\n\n    return {\n      id: generateId('sum'),\n      model,\n      summary,\n      usage: {\n        promptTokens: inputTokens,\n        completionTokens: outputTokens,\n        totalTokens: inputTokens + outputTokens,\n      },\n    }\n  }\n\n  async *summarizeStream(\n    options: SummarizationOptions,\n  ): AsyncIterable<StreamChunk> {\n    const model = options.model\n    const id = generateId('sum')\n    let accumulatedContent = ''\n    let inputTokens = 0\n    let outputTokens = 0\n\n    // Build the system prompt based on format\n    const formatInstructions = this.getFormatInstructions(options.style)\n    const lengthInstructions = options.maxLength\n      ? ` Keep the summary under ${options.maxLength} words.`\n      : ''\n\n    const systemPrompt = `You are a helpful assistant that summarizes text. ${formatInstructions}${lengthInstructions}`\n\n    const result = await this.client.models.generateContentStream({\n      model,\n      contents: [\n        {\n          role: 'user',\n          parts: [\n            { text: `Please summarize the following:\\n\\n${options.text}` },\n          ],\n        },\n      ],\n      config: {\n        systemInstruction: systemPrompt,\n      },\n    })\n\n    for await (const chunk of result) {\n      // Track usage metadata\n      if (chunk.usageMetadata) {\n        inputTokens = chunk.usageMetadata.promptTokenCount ?? inputTokens\n        outputTokens = chunk.usageMetadata.candidatesTokenCount ?? outputTokens\n      }\n\n      if (chunk.candidates?.[0]?.content?.parts) {\n        for (const part of chunk.candidates[0].content.parts) {\n          if (part.text) {\n            accumulatedContent += part.text\n            yield {\n              type: 'TEXT_MESSAGE_CONTENT',\n              messageId: id,\n              model,\n              timestamp: Date.now(),\n              delta: part.text,\n              content: accumulatedContent,\n            }\n          }\n        }\n      }\n\n      // Check for finish reason\n      const finishReason = chunk.candidates?.[0]?.finishReason\n      if (\n        finishReason === FinishReason.STOP ||\n        finishReason === FinishReason.MAX_TOKENS ||\n        finishReason === FinishReason.SAFETY\n      ) {\n        yield {\n          type: 'RUN_FINISHED',\n          runId: id,\n          model,\n          timestamp: Date.now(),\n          finishReason:\n            finishReason === FinishReason.STOP\n              ? 'stop'\n              : finishReason === FinishReason.MAX_TOKENS\n                ? 'length'\n                : 'content_filter',\n          usage: {\n            promptTokens: inputTokens,\n            completionTokens: outputTokens,\n            totalTokens: inputTokens + outputTokens,\n          },\n        }\n      }\n    }\n  }\n\n  private getFormatInstructions(\n    style?: 'paragraph' | 'bullet-points' | 'concise',\n  ): string {\n    switch (style) {\n      case 'bullet-points':\n        return 'Provide the summary as bullet points.'\n      case 'concise':\n        return 'Provide a very brief one or two sentence summary.'\n      case 'paragraph':\n      default:\n        return 'Provide the summary in paragraph form.'\n    }\n  }\n}\n\n/**\n * Creates a Gemini summarize adapter with explicit API key and model\n */\nexport function createGeminiSummarize<TModel extends GeminiSummarizeModel>(\n  apiKey: string,\n  model: TModel,\n  config?: Omit<GeminiSummarizeConfig, 'apiKey'>,\n): GeminiSummarizeAdapter<TModel> {\n  return new GeminiSummarizeAdapter({ ...config, apiKey }, model)\n}\n\n/**\n * Creates a Gemini summarize adapter with API key from environment and required model\n */\nexport function geminiSummarize<TModel extends GeminiSummarizeModel>(\n  model: TModel,\n  config?: Omit<GeminiSummarizeConfig, 'apiKey'>,\n): GeminiSummarizeAdapter<TModel> {\n  const apiKey = getGeminiApiKeyFromEnv()\n  return new GeminiSummarizeAdapter({ ...config, apiKey }, model)\n}\n"],"names":[],"mappings":"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"}