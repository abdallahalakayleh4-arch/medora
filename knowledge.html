<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medora | Advanced Clinical Search</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3a86ff;
            --accent: #38bdf8;
            --bg: #020617;
            --card-bg: rgba(30, 41, 59, 0.7);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: radial-gradient(circle at top, #1e293b, #020617);
            color: var(--text-main); margin: 0; min-height: 100vh;
        }

        /* Navbar */
        .navbar {
            position: fixed; top: 0; width: 100%; height: 70px;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border); display: flex;
            align-items: center; justify-content: space-between;
            padding: 0 40px; z-index: 1000; box-sizing: border-box;
        }

        .container { max-width: 1000px; margin: 100px auto 50px; padding: 0 20px; }

        /* Search Box */
        .search-area {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 20px; padding: 15px 25px; display: flex; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); margin-bottom: 30px;
        }
        .search-area input {
            background: transparent; border: none; color: white;
            width: 100%; font-size: 18px; outline: none; margin-left: 15px;
        }

        /* Results Card */
        .result-card {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 15px; padding: 20px; margin-bottom: 15px;
            cursor: pointer; transition: 0.3s;
        }
        .result-card:hover { border-color: var(--primary); background: rgba(30, 41, 59, 0.9); }
        .page-tag { background: var(--primary); color: white; padding: 3px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; }

        /* Modal - Improved */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(2, 6, 23, 0.95);
            z-index: 9999; overflow-y: auto; /* تم تفعيل التمرير هنا */
        }
        .modal-content {
            max-width: 850px; margin: 50px auto; background: #1e293b;
            border-radius: 20px; border: 1px solid var(--border);
            padding: 40px; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .close-btn {
            position: sticky; top: 0; float: right; background: #ef4444;
            color: white; border: none; padding: 10px 20px; border-radius: 10px;
            cursor: pointer; font-weight: bold; z-index: 1001;
        }

        .full-text { 
            white-space: pre-wrap; /* يحافظ على تقسيم السطور والفقرات من المصدر */
            line-height: 1.8; color: #e2e8f0; font-size: 16px;
        }
        .highlight { background: rgba(58, 134, 255, 0.5); border-radius: 3px; color: white; padding: 0 2px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div style="font-weight: 800; font-size: 22px;"><i class="fas fa-book-medical" style="color:var(--primary)"></i> MEDORA</div>
        <a href="dashboard.html" style="color: white; text-decoration: none; font-weight: 600; opacity: 0.8;">Back to Dashboard</a>
    </nav>

    <div class="container">
        <div class="search-area">
            <i class="fas fa-search" style="color:var(--primary)"></i>
            <input type="text" id="searchInput" placeholder="Search Davidson (e.g., Pneumonia, Treatment)...">
        </div>
        <div id="status" style="text-align:center; color: var(--text-muted); margin-bottom: 20px;">Checking Database...</div>
        <div id="results"></div>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">CLOSE (X)</button>
            <div id="modalHeader" style="margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px;"></div>
            <div id="modalBody" class="full-text"></div>
        </div>
    </div>

    <script>
        let bookData = null;

        async function init() {
            try {
                const res = await fetch('book.json');
                bookData = await res.json();
                document.getElementById('status').innerText = "Library Ready: 1500+ Pages Loaded.";
            } catch(e) { document.getElementById('status').innerText = "Error loading book.json"; }
        }

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value.trim().toLowerCase();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = "";
            if (!bookData || query.length < 3) return;

            bookData.sections.forEach(sec => {
                sec.pages.forEach((content, idx) => {
                    if (content.toLowerCase().includes(query)) {
                        const card = document.createElement('div');
                        card.className = 'result-card';
                        const pageNum = sec.startPage + idx;
                        
                        // Snippet logic
                        const pos = content.toLowerCase().indexOf(query);
                        const snippet = content.substring(Math.max(0, pos-100), pos+200).replace(/\n/g, ' ');

                        card.innerHTML = `
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <span style="color:var(--accent); font-weight:700;">Section: ${sec.section || 'General'}</span>
                                <span class="page-tag">Page ${pageNum}</span>
                            </div>
                            <div style="color:var(--text-muted); font-size:14px;">...${snippet}...</div>
                        `;
                        card.onclick = () => openModal(pageNum, content, query);
                        resultsDiv.appendChild(card);
                    }
                });
            });
        });

        function openModal(page, content, query) {
            const modal = document.getElementById('myModal');
            const body = document.getElementById('modalBody');
            const header = document.getElementById('modalHeader');
            
            header.innerHTML = `<h2 style="margin:0; color:var(--primary);">Davidson's Reference - Page ${page}</h2>`;
            
            // Highlight keyword and preserve formatting
            const highlighted = content.replace(new RegExp(`(${query})`, 'gi'), '<span class="highlight">$1</span>');
            body.innerHTML = highlighted;

            modal.style.display = "block";
            document.body.style.overflow = "hidden"; // منع حركة الصفحة الخلفية
        }

        function closeModal() {
            document.getElementById('myModal').style.display = "none";
            document.body.style.overflow = "auto";
        }

        // Close when clicking outside
        window.onclick = function(event) {
            if (event.target == document.getElementById('myModal')) closeModal();
        }

        init();
    </script>
</body>
</html>
